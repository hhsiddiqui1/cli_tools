@startuml
title 4. Payout Flow (Detailed)

actor "Admin" as Admin
participant "Your Website" as Website
participant "Your Backend" as Backend
database "Your Database" as DB
participant "Monoova API" as Monoova

skinparam sequenceMessageAlign center

== Step 1: Payout Initiation ==

Admin -> Website: Submits payout request (Customer, Amount)
Website -> Backend: **POST /api/payouts**
activate Backend

Backend -> DB: Get customer's available balance \nand payout destination details
activate DB
DB --> Backend: Return details
deactivate DB

Backend -> Backend: **Validation Logic**
note right
  1. Amount <= Available Balance?
  2. Amount <= $1000 limit?
  3. Payout destination valid?
end note

alt Validation Fails
    Backend --> Website: HTTP 400 Bad Request (with error message)
    Website --> Admin: Show validation error
else Validation Succeeds
    Backend -> Backend: Generate unique reference for the transaction

    == Step 2: API Call ==

    Backend -> Monoova: **POST /financial/v2/transaction/execute**
    activate Monoova
    note right
      **Payload (NPP PayID Example):**
      {
        "uniqueReference": "f484ec18-6e1f-481b-a4bf-bea515d8lk34",
        "totalAmount": 100,
        "paymentSource": "mAccount",
        "mAccount": { "token": "6279059726039800" },
        "description": "NPP payment to PayID",
        "disbursements": [
          {
            "disbursementMethod": "NppCreditPayId",
            "toNppCreditPayIdDetails": {
              "payId": "customer@example.com",
              "payIdType": "Email",
              "accountName": "Customer Name"
            },
            "amount": 100,
            "lodgementReference": "Payment reference"
          }
        ]
      }
    end note
    Monoova --> Backend: HTTP 200 OK (Status: "Accepted")
    deactivate Monoova

    Backend -> DB: Store transaction record with Monoova's \n `uniqueReference` and set status to 'Processing'
    activate DB
    DB --> Backend: Confirm storage
    deactivate DB

    Backend --> Website: HTTP 202 Accepted
    deactivate Backend
    Website --> Admin: Show "Payout submitted successfully"
end

... Sometime later ...

== Step 3: Asynchronous Confirmation ==

Monoova -> Backend: **Webhook: NppPaymentStatus**
activate Backend
note right
  **Webhook Payload:**
  {
    "uniqueReference": "payout-ref-xyz123",
    "status": "Completed",
    ...
  }
end note

Backend -> DB: Find transaction by `uniqueReference` \nand update status to 'Completed'
activate DB
DB --> Backend: Confirm update
deactivate DB
deactivate Backend

@enduml