# Payout System: Functional Requirements

This document outlines the functional requirements and compliance considerations for the Monoova payout integration project.

## 1. Functional Flow

This section describes the complete, end-to-end functionality of the payout system.

### 1.1. System Flows

The system is composed of four primary flows:

1.  **Funding Flow:** The process of receiving settlement funds from Fiserv into the primary Monoova mAccount.
2.  **User & Payout Destination Management Flow:** The process for an administrator to securely add and manage customers and their payout destinations (bank accounts or PayIDs).
3.  **Account Verification Flow:** An optional but recommended flow to verify ownership of a customer's bank account before the first payout.
4.  **Payout Flow:** The core process of an administrator initiating a payout to a customer, from validation through to final status confirmation via webhooks.

### 1.2. Funding Flow (Getting Money In)

Before payouts can be made, the business's Monoova account (mAccount) must be funded. The source of funds is the settlement from Fiserv, which first lands in your ANZ accounts.

1.  **Receive Fiserv Settlement:** Fiserv settles the collected transaction funds into your designated ANZ accounts.
2.  **Internal Transfer to Monoova:** You will initiate a transfer of funds from your ANZ account to your Monoova mAccount. This can be done via a standard bank transfer.
3.  **Monoova Receives Funds:** Monoova receives the funds into your primary mAccount.
4.  **Webhook Notification (Optional):** If you have configured an Automatcher account for receiving these transfers, Monoova can send an `InboundDirectCredit` or `NPPReceivePayment` webhook to a pre-configured endpoint in your backend. This webhook would confirm that funds have arrived and are available in your primary mAccount balance for payouts. **Note:** Receiving webhooks for incoming funds requires this specific 'Automatcher' account type; standard mAccounts will not trigger these notifications.
5.  **Credit mAccount:** Once funds are received by Monoova, they become available in your primary mAccount balance for making payouts.

### 1.3. User & Payout Destination Management

To pay customers, their payout destinations (bank accounts or PayIDs) must be securely stored.

1.  **Admin Onboarding:** An admin on your platform registers a new customer.
2.  **Add Payout Details:** The admin adds one or more payout destinations for that customer. The system should allow for:
    *   **Bank Account:** BSB and Account Number.
    *   **PayID:** PayID value (e.g., email, phone) and PayID type.
3.  **Secure Storage:** These details are sensitive and must be encrypted at rest in your database.
4.  **(Optional) Account Verification:** To mitigate payment failures and fraud, you can implement an account verification step using Monoova's `POST /verify/v2/npp/initiate` API. This sends a small credit with a code to the user's bank account, which they must then provide to you to confirm ownership.

### 1.3. Payout Flow (Getting Money Out)

This is the core flow for initiating a payment to a customer.

1.  **Initiate Payout:** An authorized admin logs into your web application, selects a customer, and enters a payout amount.
2.  **Backend Request:** The frontend sends a secure request to your backend (e.g., `POST /api/payouts`).
3.  **Validation:** The backend performs critical checks:
    *   Is the requested amount less than or equal to the customer's available balance?
    *   **Business rule check:** Is the amount less than or equal to the internal AUD $1000 transaction limit?
    *   Does the customer have a valid, registered payout destination?
4.  **(Optional) Validate Payload:** Before execution, it is best practice to send the constructed payload to the `POST /financial/v2/transaction/validate` endpoint. This API validates the payload structure without actually initiating a transaction, helping to prevent errors.
5.  **Construct Monoova Payload:** The backend builds the JSON payload for the `POST /financial/v2/transaction/execute` API call. The structure depends on the payout method.
    *   `uniqueReference`: A unique ID generated by you for this payout batch (e.g., a UUID).
    *   `totalAmount`: The sum of all disbursements in the batch.
    *   `paymentSource`: Must be `"mAccount"`.
    *   `mAccount`: An object containing your 16-digit mAccount `token`.
    *   `disbursements`: An array containing the payout details.

    **Example for NPP PayID Payment:**
    ```json
    {
      "uniqueReference": "f484ec18-6e1f-481b-a4bf-bea515d8lk34",
      "totalAmount": 100,
      "paymentSource": "mAccount",
      "mAccount": {
        "token": "6279059726039800"
      },
      "description": "NPP payment to PayID",
      "disbursements": [
        {
          "disbursementMethod": "NppCreditPayId",
          "toNppCreditPayIdDetails": {
            "payId": "customer@example.com",
            "payIdType": "Email",
            "accountName": "Customer Name",
            "endToEndId": "ABC/123-4356",
            "remitterName": "Your Business Name"
          },
          "sourceBSB": "802-985",
          "sourceAccountNumber": "654378888",
          "lodgementReference": "Payment reference",
          "amount": 100
        }
      ]
    }
    ```

    **Example for NPP Bank Account Payment:**
    ```json
    {
      "uniqueReference": "f484ec18-6e1f-481b-a4bf-bea515d8lk34",
      "totalAmount": 100,
      "paymentSource": "mAccount",
      "mAccount": {
        "token": "6279059726039800"
      },
      "description": "Payment via NPP to bank account",
      "disbursements": [
        {
          "disbursementMethod": "NppCreditBankAccount",
          "toNppCreditBankAccountDetails": {
            "bsbNumber": "062-205",
            "accountNumber": "123456789",
            "accountName": "Customer Name",
            "endToEndId": "ABC/123-4356",
            "remitterName": "Your Business Name"
          },
          "sourceBSB": "802-985",
          "sourceAccountNumber": "654378888",
          "lodgementReference": "Payment reference",
          "amount": 100
        }
      ]
    }
    ```
5.  **API Call:** The backend makes the authenticated call to the Monoova API.
6.  **Handle Response:**
    *   **On Success (`HTTP 200`):** The backend receives an `Accepted` status. It stores Monoova's `uniqueReference` and marks the payout as 'Processing' in the database.
    *   **On Failure (`HTTP 4xx/5xx`):** The backend logs the error and marks the payout as 'Failed'.
7.  **Asynchronous Status Update:** The system relies on webhooks (`NppPaymentStatus`, `DirectEntryDishonour`) from Monoova to receive the final transaction status (`Completed`, `Rejected`, etc.). A dedicated webhook handler in your backend updates the database accordingly.

## 2. Compliance & Standards

### 2.1. PCI DSS (Payment Card Industry Data Security Standard)

**Assessment:** **Not Applicable** to this payout system.

**Justification:**
*   PCI DSS applies to entities that **store, process, or transmit cardholder data** (e.g., Primary Account Number (PAN), expiry date, CVV).
*   In your described flow, Fiserv is the entity handling all card-present transactions. Your system does not interact with card data in any way.
*   The payout flow exclusively uses bank account numbers and PayIDs, which are not considered cardholder data and are outside the scope of PCI DSS.
*   Your responsibility is to ensure that your agreement with Fiserv clearly defines them as the responsible party for PCI DSS compliance for the acquiring part of the process.

### 2.2. NPP and BECS Regulations

**Assessment:** **Applicable, but managed via Monoova.**

**Justification:**
*   The New Payments Platform (NPP) and Bulk Electronic Clearing System (BECS) have their own technical and operational standards.
*   By using Monoova's API, you are abstracting away the complexities of directly connecting to and complying with these payment rails. Monoova, as the licensed payment provider, is responsible for adhering to the core scheme rules.
*   Your responsibilities are defined by your agreement with Monoova and general best practices:
    *   **Data Accuracy:** Ensuring the BSB, account number, and PayID information you send is correct.
    *   **Security:** Protecting your API keys and the sensitive customer data you store.
    *   **Error Handling:** Correctly processing responses and webhooks (e.g., dishonours, rejections) from the Monoova API.

### 2.3. Australian Privacy Act 1988

**Assessment:** **Applicable and Critical.**

**Justification:**
*   You are collecting and storing Personally Identifiable Information (PII), including names, contact details, and financial information (bank account numbers/PayIDs).
*   You must comply with the Australian Privacy Principles (APPs). Key obligations include:
    *   **APP 6: Use or Disclosure:** Only use the financial information for the express purpose for which it was collected (i.e., making payouts).
    *   **APP 11: Security:** Take reasonable steps to protect the PII you hold from misuse, interference, loss, and unauthorized access. This directly informs the security requirements in the `analysis.md` document (e.g., encryption, access controls).
    *   **Privacy Policy:** Have a clear and accessible privacy policy that explains what data you collect and how you use it.
